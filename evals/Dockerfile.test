# Speaker Detection Tools - Test Environment
#
# Provides reproducible testing with:
# - espeak-ng for synthetic voice generation
# - ffmpeg for audio processing
# - b3sum for blake3 hashing
# - All Python dependencies
#
# Usage:
#   docker build -f evals/Dockerfile.test -t speaker-tools-test .
#   docker run --rm speaker-tools-test
#   docker run --rm -e SPEECHMATICS_API_KEY="$KEY" speaker-tools-test
#
FROM python:3.11-slim

LABEL maintainer="CLIAI"
LABEL description="Test environment for speaker detection tools"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    espeak-ng \
    ffmpeg \
    jq \
    make \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install b3sum (blake3 hasher)
# Using prebuilt binary for speed
RUN curl -sSL https://github.com/BLAKE3-team/BLAKE3/releases/download/1.5.0/b3sum_linux_x64_bin \
    -o /usr/local/bin/b3sum \
    && chmod +x /usr/local/bin/b3sum

# Python dependencies
WORKDIR /app

# Copy requirements first for layer caching
COPY requirements*.txt ./
RUN pip install --no-cache-dir pyyaml requests

# Copy tools (order: least to most frequently changed)
COPY speaker_detection_backends/ ./speaker_detection_backends/
COPY speaker_detection speaker_samples ./
COPY stt_speechmatics.py stt_assemblyai_speaker_mapper.py ./

# Copy test infrastructure
COPY evals/ ./evals/

# Make scripts executable
RUN chmod +x speaker_detection speaker_samples

# Test-specific environment - CRITICAL for isolation
ENV SPEAKERS_EMBEDDINGS_DIR=/tmp/test_speakers
ENV SPEAKER_DETECTION_DEBUG=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Create test directory
RUN mkdir -p /tmp/test_speakers

# Verify installation
RUN espeak-ng --version && \
    ffmpeg -version | head -1 && \
    b3sum --version && \
    python3 -c "import yaml; print('PyYAML OK')"

# Default: run all tests
WORKDIR /app/evals/speaker_detection
CMD ["bash", "-c", "make all && ./test_all.sh"]
