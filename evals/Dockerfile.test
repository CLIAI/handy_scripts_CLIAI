# Speaker Detection Tools - Test Environment
#
# Provides reproducible testing with:
# - espeak-ng for synthetic voice generation
# - ffmpeg for audio processing
# - b3sum for blake3 hashing
# - All Python dependencies
#
# Usage:
#   docker build -f evals/Dockerfile.test -t speaker-tools-test .
#   docker run --rm speaker-tools-test
#   docker run --rm -e SPEECHMATICS_API_KEY="$KEY" speaker-tools-test
#
FROM python:3.11-slim

LABEL maintainer="CLIAI"
LABEL description="Test environment for speaker detection tools"

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    espeak-ng \
    ffmpeg \
    jq \
    make \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Note: b3sum (blake3) is optional - code falls back to sha256 if unavailable
# Skip b3sum installation to speed up builds (tests work without it)

# Python dependencies
WORKDIR /app

# Install Python packages
RUN pip install --no-cache-dir pyyaml requests

# Copy tools (order: least to most frequently changed)
COPY speaker_detection_backends/ ./speaker_detection_backends/
COPY speaker_detection speaker_samples ./
COPY stt_speechmatics.py ./

# Copy test infrastructure
COPY evals/ ./evals/

# Make scripts executable
RUN chmod +x speaker_detection speaker_samples evals/speaker_detection/*.py evals/speaker_detection/*.sh

# Test-specific environment - CRITICAL for isolation
ENV SPEAKERS_EMBEDDINGS_DIR=/tmp/test_speakers
ENV SPEAKER_DETECTION_DEBUG=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

# Create test directory
RUN mkdir -p /tmp/test_speakers

# Verify installation
RUN espeak-ng --version && \
    ffmpeg -version | head -1 && \
    python3 -c "import yaml; print('PyYAML OK')" && \
    ./speaker_detection --help > /dev/null && \
    ./speaker_samples --help > /dev/null

# Generate test audio at build time
RUN cd evals/speaker_detection && make all

# Default: run all unit tests
WORKDIR /app
CMD ["./evals/speaker_detection/test_all.sh", "--unit"]
